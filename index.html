<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¢³å‰ TanJi - CCUS æ·¨é›¶æ±ºç­–æ¨¡æ“¬å™¨</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; overscroll-behavior-y: none; }
        /* æ»‘æ¡¿æ¨£å¼ */
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 28px; width: 28px; border-radius: 50%;
            background: #ffffff; border: 2px solid currentColor; cursor: pointer; margin-top: -12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 6px; cursor: pointer; background: #e2e8f0; border-radius: 9999px;
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .site-card { transition: all 0.2s; }
        .site-card:active { transform: scale(0.96); }
        .dashboard-enter { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        /* éœ“è™¹å…‰æšˆç‰¹æ•ˆ */
        .glow-text { text-shadow: 0 0 10px rgba(255,255,255,0.5); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] flex flex-col overflow-hidden">

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-white shadow-sm border-b border-slate-200 flex-none z-30">
        <div class="container mx-auto px-4 h-14 md:h-16 flex justify-between items-center">
            <div class="flex items-center gap-2 md:gap-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-emerald-100 rounded-xl flex items-center justify-center text-emerald-600">
                    <i data-lucide="leaf" class="w-5 h-5 md:w-6 md:h-6"></i>
                </div>
                <div>
                    <h1 class="text-base md:text-lg font-bold text-slate-800 leading-tight">ç¢³å‰ TanJi</h1>
                    <p class="text-[10px] text-slate-500 font-medium tracking-wider hidden md:block">CCUS æ·¨é›¶æ±ºç­–æ¨¡æ“¬å™¨</p>
                </div>
            </div>
            <!-- åˆ‡æ›è¦–åœ–æŒ‰éˆ• -->
            <div class="flex gap-2">
                <button onclick="scrollToSection('simulator')" class="text-xs px-3 py-1.5 rounded-full bg-slate-100 text-slate-600 font-bold hover:bg-slate-200 transition-colors">æ¨¡æ“¬å™¨</button>
                <button onclick="scrollToSection('dashboard')" class="text-xs px-3 py-1.5 rounded-full bg-slate-800 text-white font-bold flex items-center gap-1 hover:bg-slate-700 transition-colors shadow-lg shadow-slate-900/20">
                    <div id="connection-status" class="w-2 h-2 bg-orange-400 rounded-full animate-pulse"></div> æˆ°æƒ…å®¤
                </button>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main class="flex-1 overflow-y-auto overflow-x-hidden p-3 md:p-6 no-scrollbar scroll-smooth relative" id="main-scroll">
        
        <!-- SECTION 1: æ¨¡æ“¬å™¨ -->
        <div id="section-simulator" class="container mx-auto max-w-6xl grid grid-cols-1 md:grid-cols-12 gap-4 md:gap-6 min-h-full pb-36">
            <!-- å·¦å´æ“ä½œå€ -->
            <div class="md:col-span-7 space-y-4 md:space-y-6">
                <!-- 1. å ´å€é¸æ“‡ -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 flex items-center gap-2">
                        <span class="bg-slate-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold">1</span>
                        <h2 class="text-sm md:text-base font-bold text-slate-700">é¸æ“‡å ´å€</h2>
                    </div>
                    <div class="p-4">
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                            <button onclick="selectSite('A')" id="btn-A" class="site-card p-3 rounded-xl border-2 border-slate-100 bg-white text-left flex sm:block items-center gap-3">
                                <div class="w-12 h-12 sm:w-full sm:h-20 rounded-lg bg-blue-50 text-blue-500 flex items-center justify-center text-2xl sm:text-4xl shrink-0">ğŸŒŠ</div>
                                <div><div class="font-bold text-slate-800">A. å¤–æµ·å°å­˜</div><div class="text-xs text-slate-500">Offshore</div></div>
                            </button>
                            <button onclick="selectSite('B')" id="btn-B" class="site-card p-3 rounded-xl border-2 border-slate-100 bg-white text-left flex sm:block items-center gap-3">
                                <div class="w-12 h-12 sm:w-full sm:h-20 rounded-lg bg-amber-50 text-amber-500 flex items-center justify-center text-2xl sm:text-4xl shrink-0">ğŸ­</div>
                                <div><div class="font-bold text-slate-800">B. å·¥æ¥­å€</div><div class="text-xs text-slate-500">Industrial</div></div>
                            </button>
                            <button onclick="selectSite('C')" id="btn-C" class="site-card p-3 rounded-xl border-2 border-slate-100 bg-white text-left flex sm:block items-center gap-3">
                                <div class="w-12 h-12 sm:w-full sm:h-20 rounded-lg bg-emerald-50 text-emerald-500 flex items-center justify-center text-2xl sm:text-4xl shrink-0">â›°ï¸</div>
                                <div><div class="font-bold text-slate-800">C. æ·±å±±åœ°è³ª</div><div class="text-xs text-slate-500">Mountain</div></div>
                            </button>
                        </div>
                        <div id="site-desc" class="mt-3 text-sm text-slate-600 bg-slate-50 p-3 rounded-lg border border-slate-200"></div>
                    </div>
                </div>

                <!-- 2. åƒæ•¸èª¿æ•´ -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200">
                    <div class="px-4 py-3 border-b border-slate-100 bg-slate-50 flex items-center gap-2">
                        <span class="bg-slate-800 text-white w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold">2</span>
                        <h2 class="text-sm md:text-base font-bold text-slate-700">è³‡æºé…ç½®</h2>
                    </div>
                    <div class="p-5 space-y-6">
                        <div>
                            <div class="flex justify-between mb-2"><label class="text-sm font-bold text-slate-700 flex gap-2"><i data-lucide="shield-check" class="w-4 h-4 text-blue-500"></i>å®‰å…¨ç›£æ¸¬</label><span class="text-xs font-bold text-blue-500" id="val-safety">æ¨™æº–</span></div>
                            <input type="range" min="1" max="5" value="3" class="text-blue-500" id="slider-safety" oninput="updateSimulation()">
                        </div>
                        <div>
                            <div class="flex justify-between mb-2"><label class="text-sm font-bold text-slate-700 flex gap-2"><i data-lucide="coins" class="w-4 h-4 text-amber-500"></i>å›é¥‹é‡‘</label><span class="text-xs font-bold text-amber-500" id="val-money">æ¨™æº–</span></div>
                            <input type="range" min="1" max="5" value="2" class="text-amber-500" id="slider-money" oninput="updateSimulation()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- å³å´å„€è¡¨æ¿ -->
            <div class="md:col-span-5 space-y-4">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden relative">
                    <div class="p-4 bg-slate-50 border-b border-slate-100"><h3 class="font-bold text-center text-slate-800">å€‹äººè©•ä¼° (Your Impact)</h3></div>
                    <div class="p-4 h-[220px] relative"><canvas id="radarChart"></canvas></div>
                    <div class="grid grid-cols-3 divide-x divide-slate-100 border-t border-slate-100 bg-slate-50">
                        <div class="p-2 text-center"><div class="text-[10px] text-slate-400 font-bold">SAFETY</div><div class="text-lg font-black text-blue-600" id="score-safety">0</div></div>
                        <div class="p-2 text-center"><div class="text-[10px] text-slate-400 font-bold">ECONOMY</div><div class="text-lg font-black text-amber-600" id="score-economy">0</div></div>
                        <div class="p-2 text-center"><div class="text-[10px] text-slate-400 font-bold">SOCIAL</div><div class="text-lg font-black text-emerald-600" id="score-social">0</div></div>
                    </div>
                </div>
                <div class="bg-indigo-50 rounded-2xl border border-indigo-100 p-4">
                    <h3 class="font-bold text-indigo-900 flex items-center gap-2 mb-2 text-sm"><i data-lucide="bot" class="w-4 h-4"></i> AI æ±ºç­–åˆ†æ</h3>
                    <p id="ai-feedback" class="text-sm text-indigo-800 leading-relaxed">...</p>
                </div>
                <div class="h-20 md:hidden"></div>
            </div>
        </div>

        <!-- SECTION 2: å…¨ç­æˆ°æƒ…å®¤ -->
        <div id="section-dashboard" class="container mx-auto max-w-6xl mt-12 mb-24 hidden dashboard-enter">
            <div class="flex items-center gap-3 mb-6">
                <div class="w-1 h-8 bg-slate-800 rounded-full"></div>
                <h2 class="text-2xl font-black text-slate-800">å…¨ç­æ±ºç­–æˆ°æƒ…å®¤</h2>
                <div id="mode-badge" class="text-xs bg-orange-500 text-white px-2 py-1 rounded animate-pulse">æ¨¡æ“¬æ¼”ç¤ºæ¨¡å¼ (Mock Mode)</div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-600 mb-4 text-center">é¸å€åˆ†ä½ˆ (Site Distribution)</h3>
                    <div class="h-[200px] relative"><canvas id="pieChart"></canvas></div>
                    <div class="mt-4 grid grid-cols-3 text-center text-xs">
                        <div><span class="text-blue-500 font-bold">å¤–æµ·</span><br><span id="count-A">0</span>äºº</div>
                        <div><span class="text-amber-500 font-bold">å·¥æ¥­å€</span><br><span id="count-B">0</span>äºº</div>
                        <div><span class="text-emerald-500 font-bold">æ·±å±±</span><br><span id="count-C">0</span>äºº</div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="font-bold text-slate-600 mb-4 text-center">å…¨ç­ SROI å¹³å‡æŒ‡æ¨™</h3>
                    <div class="h-[200px] relative"><canvas id="barChart"></canvas></div>
                </div>
                <div class="bg-slate-900 text-slate-300 p-5 rounded-2xl shadow-sm border border-slate-800 overflow-hidden flex flex-col">
                    <h3 class="font-bold text-white mb-4 flex items-center gap-2"><i data-lucide="activity" class="w-4 h-4 text-green-400"></i> æœ€æ–°æ±ºç­–å‹•æ…‹</h3>
                    <div class="flex-1 overflow-y-auto space-y-3 pr-2 text-sm h-[200px]" id="activity-log"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- åº•éƒ¨æµ®å‹•å€ (Footer) -->
    <div class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-slate-200 p-3 md:p-4 z-50 shadow-[0_-8px_30px_rgba(0,0,0,0.12)]" id="footer-action">
        <div class="container mx-auto max-w-5xl flex flex-col md:flex-row items-center justify-between gap-3">
            
            <!-- å·¦å´ï¼šæ•™æ¡ˆè³‡è¨Š -->
            <div class="hidden md:block flex-1 text-left opacity-60 hover:opacity-100 transition-opacity">
                <div class="text-[10px] font-bold uppercase tracking-widest text-slate-500">Project</div>
                <div class="text-xs font-medium text-slate-600">115 å¹´åº¦ ç¬¬äºŒå±† CCUS å‰µæ„æ•™æ¡ˆ</div>
            </div>

            <!-- ä¸­é–“ï¼šç¸½åˆ†å¡ç‰‡ -->
            <div class="w-full md:w-auto flex justify-center md:flex-none">
                <div class="flex flex-col items-center bg-slate-800 text-white px-8 py-2 rounded-2xl shadow-lg border border-slate-700 min-w-[160px] transform md:-translate-y-2 transition-transform hover:scale-105">
                    <div class="text-[9px] text-emerald-400 font-bold tracking-widest uppercase mb-0.5">SROI æ°¸çºŒç¸¾æ•ˆ</div>
                    <div class="text-4xl md:text-5xl font-black leading-none glow-text tabular-nums" id="footer-score">0.0</div>
                </div>
            </div>

            <!-- å³å´ï¼šé€å‡ºæŒ‰éˆ• -->
            <div class="w-full md:w-auto md:flex-1 flex justify-end">
                <button onclick="submitDecision()" class="w-full md:w-auto bg-emerald-600 hover:bg-emerald-500 text-white px-6 md:px-8 py-3.5 rounded-full font-bold shadow-lg shadow-emerald-600/30 flex items-center justify-center gap-2 transition-all active:scale-95 group border border-emerald-400">
                    <span id="btn-text" class="text-sm md:text-base">æäº¤æ±ºç­–</span>
                    <i data-lucide="arrow-right" class="w-5 h-5 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
            
            <div class="md:hidden text-[10px] text-slate-400 font-medium pt-1">
                115 å¹´åº¦ ç¬¬äºŒå±† CCUS å‰µæ„æ•™æ¡ˆ
            </div>
        </div>
    </div>

    <!-- Firebase æ•´åˆè…³æœ¬ -->
    <!-- type="module" å…è¨±æˆ‘å€‘ä½¿ç”¨ import èªæ³•å¼•å…¥ Firebase SDK -->
    <script type="module">
        // 1. å¼•å…¥ Firebase SDK (ä½¿ç”¨ CDN æ¨¡çµ„)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, limit, serverTimestamp } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ============================================
        //  è¨­å®šå€ï¼šè«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Firebase è¨­å®š (Config)
        // ============================================
        const firebaseConfig = {
            // è«‹å°‡æ‚¨çš„ Firebase è¨­å®šè²¼åœ¨é€™è£¡
            // apiKey: "AIzaSy...",
            // authDomain: "your-project.firebaseapp.com",
            // projectId: "your-project",
            // storageBucket: "your-project.appspot.com",
            // messagingSenderId: "...",
            // appId: "..."
        };

        // ç‹€æ…‹è®Šæ•¸
        let db = null;
        let isFirebaseActive = false;
        let mockInterval = null;

        // 2. åˆå§‹åŒ– (è‡ªå‹•åˆ¤æ–·æ¨¡å¼)
        function initApp() {
            // æª¢æŸ¥æ˜¯å¦å·²å¡«å¯« Config (åˆ¤æ–· apiKey æ˜¯å¦å­˜åœ¨)
            if (firebaseConfig.apiKey) {
                try {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    isFirebaseActive = true;
                    console.log("ğŸ”¥ Firebase é€£ç·šæˆåŠŸï¼é€²å…¥å³æ™‚æ¨¡å¼ã€‚");
                    
                    // UI æ›´æ–°
                    document.getElementById('mode-badge').className = "text-xs bg-green-500 text-white px-2 py-1 rounded animate-pulse";
                    document.getElementById('mode-badge').innerText = "Firebase å³æ™‚é€£ç·š (Live)";
                    document.getElementById('connection-status').className = "w-2 h-2 bg-green-400 rounded-full animate-pulse";
                    
                    // å•Ÿå‹•ç›£è½
                    listenToDecisions();
                } catch (e) {
                    console.error("Firebase åˆå§‹åŒ–å¤±æ•—:", e);
                    fallbackToMock();
                }
            } else {
                console.log("âš ï¸ æœªæª¢æ¸¬åˆ° Firebase Configï¼Œé€²å…¥æ¨¡æ“¬æ¼”ç¤ºæ¨¡å¼ã€‚");
                fallbackToMock();
            }
        }

        // 3. å‚™æ´æ¨¡å¼ (Mock Mode) - ç•¶æ²’æœ‰ Firebase æ™‚ä½¿ç”¨å‡è³‡æ–™
        function fallbackToMock() {
            isFirebaseActive = false;
            // UI æ›´æ–°
            document.getElementById('mode-badge').className = "text-xs bg-orange-500 text-white px-2 py-1 rounded";
            document.getElementById('mode-badge').innerText = "æ¨¡æ“¬æ¼”ç¤ºæ¨¡å¼ (Mock)";
            document.getElementById('connection-status').className = "w-2 h-2 bg-orange-400 rounded-full animate-pulse";
        }

        // 4. ç›£è½æ•¸æ“š (Firebase Reader)
        function listenToDecisions() {
            if (!db) return;
            
            // ç›£è½ 'decisions' é›†åˆï¼ŒæŒ‰æ™‚é–“å€’åºï¼Œå–æœ€æ–° 50 ç­†
            const q = query(collection(db, "decisions"), orderBy("timestamp", "desc"), limit(50));
            
            onSnapshot(q, (snapshot) => {
                // é‡ç½®çµ±è¨ˆæ•¸æ“š
                const stats = { A: 0, B: 0, C: 0, s: 0, e: 0, o: 0, count: 0 };
                const logs = [];

                snapshot.forEach((doc) => {
                    const d = doc.data();
                    // ç´¯åŠ é¸å€
                    if (stats[d.site] !== undefined) stats[d.site]++;
                    // ç´¯åŠ åˆ†æ•¸
                    stats.s += d.scores.s;
                    stats.e += d.scores.e;
                    stats.o += d.scores.o;
                    stats.count++;
                    
                    // æ—¥èªŒæ•¸æ“š
                    logs.push({
                        user: d.user || "åŒ¿åè¦åŠƒå¸«",
                        site: d.site,
                        time: d.timestamp ? new Date(d.timestamp.seconds * 1000).toLocaleTimeString() : "Just now"
                    });
                });

                // æ›´æ–°å…¨åŸŸè³‡æ–™ (è®“åœ–è¡¨é‡ç¹ª)
                if (stats.count > 0) {
                    window.classData.siteCounts = { A: stats.A, B: stats.B, C: stats.C };
                    window.classData.scores = { 
                        s: Math.round(stats.s / stats.count), 
                        e: Math.round(stats.e / stats.count), 
                        o: Math.round(stats.o / stats.count) 
                    };
                    window.classData.log = logs; // Firebase å·²ç¶“æ’åºå¥½äº†
                    
                    // è§¸ç™¼åœ–è¡¨æ›´æ–°
                    updateDashboardUI(); 
                }
            });
        }

        // 5. é€å‡ºæ•¸æ“š (Firebase Writer)
        // ç‚ºäº†è®“å¤–éƒ¨ HTML onclick èƒ½å‘¼å«ï¼Œéœ€æ›è¼‰åˆ° window
        window.submitDecision = async function() {
            const btn = document.querySelector('#footer-action button');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> ä¸Šå‚³ä¸­...`;
            lucide.createIcons();

            // æº–å‚™æ•¸æ“š
            const currentScore = {
                s: parseInt(document.getElementById('score-safety').innerText),
                e: parseInt(document.getElementById('score-economy').innerText),
                o: parseInt(document.getElementById('score-social').innerText)
            };
            
            const payload = {
                site: window.state.site, // å¾å…¨åŸŸè®Šæ•¸è®€å–
                scores: currentScore,
                user: `å­¸ç”Ÿ_${Math.floor(Math.random()*999)}`, // å¯¦å‹™ä¸Šå¯è®“å­¸ç”Ÿè¼¸å…¥åå­—
                timestamp: isFirebaseActive ? serverTimestamp() : new Date()
            };

            try {
                if (isFirebaseActive && db) {
                    // å¯«å…¥ Firebase
                    await addDoc(collection(db, "decisions"), payload);
                    console.log("æ•¸æ“šå·²å¯«å…¥ Firebase");
                } else {
                    // å¯«å…¥å‡è³‡æ–™ (Mock)
                    console.log("æ¨¡æ“¬å¯«å…¥:", payload);
                    // æ¨¡æ“¬å»¶é²
                    await new Promise(r => setTimeout(r, 800));
                    // è§¸ç™¼æ¨¡æ“¬æˆ°æƒ…å®¤
                    window.startLiveSimulation(); 
                }

                // UI å›é¥‹
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> å·²é€å‡º`;
                btn.className = "w-full md:w-auto bg-slate-700 text-white px-6 md:px-8 py-3.5 rounded-full font-bold shadow-none flex items-center justify-center gap-2 cursor-default pointer-events-none";
                
                // é¡¯ç¤ºæˆ°æƒ…å®¤
                document.getElementById('section-dashboard').classList.remove('hidden');
                setTimeout(() => {
                    document.getElementById('section-dashboard').scrollIntoView({ behavior: 'smooth' });
                }, 500);

            } catch (error) {
                console.error("ä¸Šå‚³å¤±æ•—", error);
                alert("ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·š");
                btn.innerHTML = originalText;
            }
        };

        // å•Ÿå‹•
        initApp();

    </script>

    <!-- åŸæœ‰çš„é‚è¼¯è…³æœ¬ (UIæ“ä½œã€åœ–è¡¨ç¹ªè£½) -->
    <script>
        lucide.createIcons();
        const sites = { 'A': { name: 'å¤–æµ·', desc: 'é é›¢å±…ä½å€ï¼Œç„¡é„°é¿å•é¡Œï¼Œä½†æµ·åº•ç®¡ç·šæˆæœ¬æ¥µé«˜ã€‚', base: { s: 85, e: 20, o: 95 } }, 'B': { name: 'å·¥æ¥­å€', desc: 'é‹è¼¸æˆæœ¬ä½ï¼Œä½†é„°é¿é¢¨éšªé«˜ï¼Œéœ€æ¥µé«˜çš„æºé€šæˆæœ¬ã€‚', base: { s: 50, e: 95, o: 15 } }, 'C': { name: 'æ·±å±±', desc: 'åœ°è³ªç©©å®šï¼Œä½†å¯èƒ½ç ´å£ç”Ÿæ…‹ï¼Œéœ€æ¬Šè¡¡ç’°ä¿è­°é¡Œã€‚', base: { s: 70, e: 60, o: 55 } } };
        
        // å°‡ state æ›è¼‰åˆ° window è®“ Module è®€å–
        window.state = { site: 'A', safety: 3, money: 2 };
        
        // å°‡ classData æ›è¼‰åˆ° window è®“ Firebase æ›´æ–°
        window.classData = { siteCounts: { 'A': 12, 'B': 8, 'C': 5 }, scores: { s: 75, e: 60, o: 65 }, log: [] };
        
        let radarChart = null;
        let pieChart = null, barChart = null;
        let isSimulationRunning = false;

        window.onload = function() {
            initRadar();
            selectSite('A');
            initDashboardCharts();
            renderLog();
        };

        // ... (ä¿ç•™åŸæœ‰çš„ UI æ“ä½œå‡½å¼) ...
        function selectSite(id) {
            window.state.site = id; // æ›´æ–°å…¨åŸŸç‹€æ…‹
            ['A','B','C'].forEach(s => {
                const btn = document.getElementById(`btn-${s}`);
                if (s === id) {
                    btn.className = "site-card p-3 rounded-xl border-2 bg-emerald-50 border-emerald-500 text-left flex sm:block items-center gap-3 ring-2 ring-emerald-200";
                } else {
                    btn.className = "site-card p-3 rounded-xl border-2 border-slate-100 bg-white text-left flex sm:block items-center gap-3 opacity-70 hover:opacity-100";
                }
            });
            document.getElementById('site-desc').innerText = sites[id].desc;
            updateSimulation();
        }

        function updateSimulation() {
            window.state.safety = parseInt(document.getElementById('slider-safety').value);
            window.state.money = parseInt(document.getElementById('slider-money').value);
            const labels = ['ä½', 'ä½', 'æ¨™æº–', 'é«˜', 'é«˜'];
            document.getElementById('val-safety').innerText = labels[window.state.safety-1];
            document.getElementById('val-money').innerText = labels[window.state.money-1];
            const base = sites[window.state.site].base;
            let s = Math.min(100, base.s + (window.state.safety * 5));
            let e = Math.max(10, base.e - (Math.pow(window.state.safety, 1.2)*5) - (window.state.money*8));
            let o = Math.min(100, Math.max(0, base.o + (window.state.money*10)));
            if(window.state.site === 'B' && s < 70) o -= 20;
            document.getElementById('score-safety').innerText = parseInt(s);
            document.getElementById('score-economy').innerText = parseInt(e);
            document.getElementById('score-social').innerText = parseInt(o);
            const total = ((s*0.4)+(e*0.25)+(o*0.35)).toFixed(1);
            document.getElementById('footer-score').innerText = total;
            radarChart.data.datasets[0].data = [s, e, o];
            radarChart.update();
            let msg = "æ–¹æ¡ˆå¹³è¡¡ã€‚";
            if(s<60) msg = "âš ï¸ å®‰å…¨æ€§éä½ï¼Œç’°è©•é¢¨éšªå¤§ã€‚";
            else if(o<50) msg = "ğŸ“¢ å±…æ°‘æŠ—çˆ­é¢¨éšªé«˜ï¼Œè«‹å¢åŠ å›é¥‹ã€‚";
            else if(e<30) msg = "ğŸ’° æˆæœ¬éé«˜ï¼Œè²¡å‹™ä¸å¯è¡Œã€‚";
            document.getElementById('ai-feedback').innerText = msg;
        }

        // ... (Chart åˆå§‹åŒ–) ...
        function initRadar() {
            const ctx = document.getElementById('radarChart').getContext('2d');
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: { labels: ['å®‰å…¨æ€§', 'ç¶“æ¿Ÿ', 'ç¤¾æœƒ'], datasets: [{ data: [50,50,50], backgroundColor: 'rgba(16,185,129,0.2)', borderColor: '#10b981', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } }
            });
        }

        function scrollToSection(id) {
            const el = document.getElementById(`section-${id}`);
            if(el) { el.classList.remove('hidden'); el.scrollIntoView({ behavior: 'smooth' }); }
        }

        function initDashboardCharts() {
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            pieChart = new Chart(ctxPie, {
                type: 'doughnut',
                data: { labels: ['å¤–æµ·', 'å·¥æ¥­å€', 'æ·±å±±'], datasets: [{ data: [12, 8, 5], backgroundColor: ['#3b82f6', '#f59e0b', '#10b981'] }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
            });
            const ctxBar = document.getElementById('barChart').getContext('2d');
            barChart = new Chart(ctxBar, {
                type: 'bar',
                data: { labels: ['å¹³å‡å®‰å…¨', 'å¹³å‡ç¶“æ¿Ÿ', 'å¹³å‡ç¤¾æœƒ'], datasets: [{ label: 'å…¨ç­å¹³å‡', data: [75, 60, 65], backgroundColor: ['rgba(59,130,246,0.7)', 'rgba(245,158,11,0.7)', 'rgba(16,185,129,0.7)'], borderRadius: 5 }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
            });
        }

        // é€™æ˜¯è®“ Firebase æˆ– Mock å‘¼å«çš„æ›´æ–°å‡½å¼
        window.updateDashboardUI = function() {
            // æ›´æ–°åœ“é¤…åœ–
            pieChart.data.datasets[0].data = [
                window.classData.siteCounts.A, 
                window.classData.siteCounts.B, 
                window.classData.siteCounts.C
            ];
            pieChart.update();

            // æ›´æ–°é•·æ¢åœ–
            barChart.data.datasets[0].data = [
                window.classData.scores.s, 
                window.classData.scores.e, 
                window.classData.scores.o
            ];
            barChart.update();

            // æ›´æ–°ä¸‹æ–¹æ•¸å­—
            document.getElementById('count-A').innerText = window.classData.siteCounts.A;
            document.getElementById('count-B').innerText = window.classData.siteCounts.B;
            document.getElementById('count-C').innerText = window.classData.siteCounts.C;
            
            // æ›´æ–° Log
            renderLog();
        }

        function renderLog() {
            const logEl = document.getElementById('activity-log');
            logEl.innerHTML = '';
            // é¡¯ç¤ºæœ€æ–° 10 ç­†
            window.classData.log.slice(0, 20).forEach(entry => {
                const newLog = document.createElement('div');
                newLog.className = "flex justify-between items-center border-b border-slate-800 pb-2";
                const color = entry.site === 'A' ? 'text-blue-400' : (entry.site === 'B' ? 'text-amber-400' : 'text-emerald-400');
                const siteName = entry.site === 'A' ? 'å¤–æµ·' : (entry.site === 'B' ? 'å·¥æ¥­å€' : 'æ·±å±±');
                newLog.innerHTML = `<div class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-slate-500"></div><span>${entry.user}</span></div><div class="${color} font-bold text-xs">${siteName}</div>`;
                logEl.appendChild(newLog);
            });
        }

        // é€™æ˜¯èˆŠçš„æ¨¡æ“¬å‡½å¼ï¼Œç•¶æ²’ Firebase æ™‚æ‰æœƒè¢«å‘¼å«
        window.startLiveSimulation = function() {
            if (isSimulationRunning) return;
            isSimulationRunning = true;
            setInterval(() => {
                const randomSite = ['A', 'B', 'C'][Math.floor(Math.random() * 3)];
                const randomUser = `åŒå­¸_${Math.floor(Math.random()*90 + 10)}`;
                window.classData.siteCounts[randomSite]++;
                window.classData.scores.s += (Math.random()*10 - 5);
                window.classData.log.unshift({ user: randomUser, site: randomSite, time: "Now" });
                updateDashboardUI();
            }, 3000);
        }
    </script>
</body>
</html>
