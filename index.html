<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¢³å‰ TanJi - CCUS æ·¨é›¶æ±ºç­–æ¨¡æ“¬å™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; overscroll-behavior-y: none; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px; border-radius: 50%;
            background: #ffffff; border: 2px solid currentColor; cursor: pointer; margin-top: -10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; cursor: pointer; background: #e2e8f0; border-radius: 9999px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .site-card { transition: all 0.2s; }
        .site-card:active { transform: scale(0.96); }
        .dashboard-enter { animation: slideUp 0.5s ease-out forwards; }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .glow-text { text-shadow: 0 0 10px rgba(255,255,255,0.5); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-[100dvh] flex flex-col overflow-hidden">

    <!-- ç™»å…¥ç•«é¢ -->
    <div id="login-screen" class="fixed inset-0 bg-slate-900 z-50 flex flex-col items-center justify-center p-6 text-white transition-opacity duration-500">
        <div class="w-16 h-16 bg-emerald-500 rounded-2xl flex items-center justify-center mb-6 shadow-2xl shadow-emerald-500/50">
            <i data-lucide="leaf" class="w-8 h-8 text-white"></i>
        </div>
        <h1 class="text-3xl font-black mb-2 tracking-tight">ç¢³å‰ TanJi</h1>
        <p class="text-slate-400 mb-8 text-sm">CCUS æ·¨é›¶æ±ºç­–æ¨¡æ“¬ç³»çµ±</p>
        
        <div class="w-full max-w-sm space-y-4">
            <div>
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">å°çµ„åç¨± / èª²ç¨‹ä»£ç¢¼</label>
                <input type="text" id="login-team" placeholder="è¼¸å…¥å°çµ„å" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 mt-1 text-white font-bold focus:ring-2 focus:ring-emerald-500 outline-none transition-all">
                <p class="text-[10px] text-slate-500 mt-1">* è€å¸«è«‹è¼¸å…¥å°ˆç”¨ä»£ç¢¼ç™»å…¥æˆ°æƒ…å®¤</p>
            </div>
            
            <div id="role-selector">
                <label class="text-xs font-bold text-slate-400 uppercase ml-1">é¸æ“‡æ‚¨çš„è§’è‰²</label>
                <div class="grid grid-cols-2 gap-2 mt-1">
                    <button onclick="selectRole('engineer')" class="role-btn bg-slate-800 border border-slate-700 p-3 rounded-xl text-left hover:border-emerald-500 transition-all group">
                        <div class="text-xl mb-1">ğŸ”§</div>
                        <div class="text-xs font-bold text-slate-300 group-hover:text-white">ç’°å¢ƒå·¥ç¨‹å¸«</div>
                    </button>
                    <button onclick="selectRole('cfo')" class="role-btn bg-slate-800 border border-slate-700 p-3 rounded-xl text-left hover:border-emerald-500 transition-all group">
                        <div class="text-xl mb-1">ğŸ’°</div>
                        <div class="text-xs font-bold text-slate-300 group-hover:text-white">è²¡å‹™é•·</div>
                    </button>
                    <button onclick="selectRole('pr')" class="role-btn bg-slate-800 border border-slate-700 p-3 rounded-xl text-left hover:border-emerald-500 transition-all group">
                        <div class="text-xl mb-1">ğŸ“¢</div>
                        <div class="text-xs font-bold text-slate-300 group-hover:text-white">å…¬é—œç¶“ç†</div>
                    </button>
                    <button onclick="selectRole('eco')" class="role-btn bg-slate-800 border border-slate-700 p-3 rounded-xl text-left hover:border-emerald-500 transition-all group">
                        <div class="text-xl mb-1">ğŸŒ±</div>
                        <div class="text-xs font-bold text-slate-300 group-hover:text-white">ç”Ÿæ…‹ä¿è‚²å“¡</div>
                    </button>
                    <button onclick="selectRole('policy')" class="role-btn bg-slate-800 border border-slate-700 p-3 rounded-xl text-left hover:border-emerald-500 transition-all group col-span-2">
                        <div class="text-xl mb-1 flex items-center gap-2">ğŸ“œ <span class="text-xs bg-emerald-900 text-emerald-400 px-1.5 rounded">éšŠé•·</span></div>
                        <div class="text-xs font-bold text-slate-300 group-hover:text-white">æ”¿ç­–åˆ†æå¸«</div>
                    </button>
                </div>
            </div>

            <!-- æŒ‰éˆ• id ä¿æŒä¸è®Šï¼Œä½†åœ¨ JS ä¸­æœƒå‹•æ…‹æ”¹è®Šæ–‡å­— -->
            <button id="start-btn" onclick="enterSimulation()" disabled class="w-full bg-emerald-600 disabled:bg-slate-700 disabled:text-slate-500 text-white py-4 rounded-xl font-bold mt-4 transition-all shadow-lg shadow-emerald-600/20">
                é€²å…¥ç³»çµ±
            </button>
        </div>
    </div>

    <!-- é ‚éƒ¨å°èˆª -->
    <nav class="bg-white shadow-sm border-b border-slate-200 flex-none z-30">
        <div class="container mx-auto px-4 h-14 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <div class="w-8 h-8 bg-emerald-100 rounded-lg flex items-center justify-center text-emerald-600">
                    <i data-lucide="leaf" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-base font-bold text-slate-800">ç¢³å‰ TanJi</h1>
                    <p class="text-[10px] text-slate-500 font-bold" id="header-team-info">æœªç™»å…¥</p>
                </div>
            </div>
            <div id="connection-indicator" class="flex items-center gap-1.5 px-2 py-1 bg-slate-100 rounded-full">
                <div class="w-2 h-2 bg-slate-400 rounded-full"></div>
                <span class="text-[10px] font-bold text-slate-500">é›¢ç·š</span>
            </div>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ (å­¸ç”Ÿæ¨¡æ“¬å™¨) -->
    <main id="main-student" class="flex-1 overflow-y-auto p-4 pb-40 no-scrollbar relative hidden">
        <div class="container mx-auto max-w-5xl grid grid-cols-1 lg:grid-cols-12 gap-6">
            <!-- å·¦å´ï¼šæ±ºç­–é¢æ¿ -->
            <div class="lg:col-span-7 space-y-4">
                <!-- é¸å€å€å¡Š -->
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden relative">
                    <div class="px-4 py-2 bg-slate-50 border-b border-slate-100 flex justify-between items-center">
                        <h2 class="text-sm font-bold text-slate-700">1. é¸å€æ±ºç­–</h2>
                        <span class="text-[10px] bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded font-bold">ğŸ“œ æ”¿ç­–åˆ†æå¸«</span>
                    </div>
                    <div class="p-3 grid grid-cols-3 gap-2">
                        <button onclick="updateTeamState('site', 'A')" id="btn-A" class="site-card p-3 rounded-xl border-2 border-slate-100 text-center"><div class="text-2xl mb-1">ğŸŒŠ</div><div class="text-xs font-bold">å¤–æµ·</div></button>
                        <button onclick="updateTeamState('site', 'B')" id="btn-B" class="site-card p-3 rounded-xl border-2 border-slate-100 text-center"><div class="text-2xl mb-1">ğŸ­</div><div class="text-xs font-bold">å·¥æ¥­å€</div></button>
                        <button onclick="updateTeamState('site', 'C')" id="btn-C" class="site-card p-3 rounded-xl border-2 border-slate-100 text-center"><div class="text-2xl mb-1">â›°ï¸</div><div class="text-xs font-bold">æ·±å±±</div></button>
                    </div>
                    <div id="lock-site" class="absolute inset-0 bg-white/60 backdrop-blur-[1px] flex items-center justify-center z-10 hidden cursor-not-allowed"><span class="text-xs font-bold text-slate-400 bg-white px-2 py-1 rounded border shadow-sm">ğŸ”’ åƒ…åˆ†æå¸«å¯æ“ä½œ</span></div>
                </div>

                <!-- è³‡æºé…ç½®å€å¡Š -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 relative overflow-hidden">
                        <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-slate-700 flex gap-1"><i data-lucide="shield-check" class="w-4 h-4 text-blue-500"></i> å®‰å…¨ç›£æ¸¬</label><span class="text-[10px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-bold">ğŸ”§ å·¥ç¨‹å¸«</span></div>
                        <input type="range" min="1" max="5" value="3" id="slider-safety" class="text-blue-500" oninput="updateTeamState('safety', this.value)">
                        <div class="flex justify-between text-[10px] text-slate-400 mt-2"><span>ä½</span><span id="val-safety" class="font-bold text-blue-600">æ¨™æº–</span><span>é«˜</span></div>
                        <div id="lock-safety" class="absolute inset-0 bg-white/60 z-10 hidden"></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 relative overflow-hidden">
                        <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-slate-700 flex gap-1"><i data-lucide="coins" class="w-4 h-4 text-amber-500"></i> å›é¥‹é‡‘</label><span class="text-[10px] bg-amber-100 text-amber-600 px-2 py-0.5 rounded font-bold">ğŸ“¢ å…¬é—œ</span></div>
                        <input type="range" min="1" max="5" value="2" id="slider-pr" class="text-amber-500" oninput="updateTeamState('pr', this.value)">
                        <div class="flex justify-between text-[10px] text-slate-400 mt-2"><span>å°‘</span><span id="val-pr" class="font-bold text-amber-600">æ¨™æº–</span><span>å¤š</span></div>
                        <div id="lock-pr" class="absolute inset-0 bg-white/60 z-10 hidden"></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 relative overflow-hidden">
                        <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-slate-700 flex gap-1"><i data-lucide="sprout" class="w-4 h-4 text-emerald-500"></i> ç”Ÿæ…‹è£œå„Ÿ</label><span class="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded font-bold">ğŸŒ± ç”Ÿæ…‹å“¡</span></div>
                        <input type="range" min="1" max="5" value="2" id="slider-eco" class="text-emerald-500" oninput="updateTeamState('eco', this.value)">
                        <div class="flex justify-between text-[10px] text-slate-400 mt-2"><span>åŸºæœ¬</span><span id="val-eco" class="font-bold text-emerald-600">æ¨™æº–</span><span>åš´æ ¼</span></div>
                        <div id="lock-eco" class="absolute inset-0 bg-white/60 z-10 hidden"></div>
                    </div>
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-4 relative overflow-hidden">
                        <div class="flex justify-between mb-2 items-center"><label class="text-sm font-bold text-slate-700 flex gap-1"><i data-lucide="piggy-bank" class="w-4 h-4 text-rose-500"></i> é ç®—ç·Šç¸®</label><span class="text-[10px] bg-rose-100 text-rose-600 px-2 py-0.5 rounded font-bold">ğŸ’° è²¡å‹™é•·</span></div>
                        <input type="range" min="1" max="5" value="2" id="slider-cfo" class="text-rose-500" oninput="updateTeamState('cfo', this.value)">
                        <div class="flex justify-between text-[10px] text-slate-400 mt-2"><span>å¯¬é¬†</span><span id="val-cfo" class="font-bold text-rose-600">æ¨™æº–</span><span>åš´æ ¼</span></div>
                        <div id="lock-cfo" class="absolute inset-0 bg-white/60 z-10 hidden"></div>
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šå„€è¡¨æ¿ -->
            <div class="lg:col-span-5 space-y-4">
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 p-4">
                    <div class="flex justify-between items-center mb-2"><h3 class="font-bold text-slate-800">SROI é æ¸¬æ¨¡å‹</h3><span class="text-[10px] text-slate-400">Team Sync Active</span></div>
                    <div class="h-[200px] relative"><canvas id="radarChart"></canvas></div>
                    <div class="mt-3 space-y-1">
                        <div class="flex justify-between text-xs border-b border-slate-50 pb-1"><span class="text-slate-500">å®‰å…¨æ€§</span><span id="score-safety" class="font-bold text-blue-600">0</span></div>
                        <div class="flex justify-between text-xs border-b border-slate-50 pb-1"><span class="text-slate-500">ç¶“æ¿Ÿæ€§</span><span id="score-economy" class="font-bold text-amber-600">0</span></div>
                        <div class="flex justify-between text-xs"><span class="text-slate-500">ç¤¾æœƒæ€§</span><span id="score-social" class="font-bold text-emerald-600">0</span></div>
                    </div>
                </div>
                <div class="bg-slate-800 p-4 rounded-xl border border-slate-700">
                    <h4 class="text-xs font-bold text-emerald-400 mb-2 flex items-center gap-1"><i data-lucide="terminal" class="w-3 h-3"></i> å³æ™‚å”ä½œç´€éŒ„</h4>
                    <div id="system-log" class="text-xs text-slate-400 h-24 overflow-y-auto space-y-1 font-mono">ç­‰å¾…é€£ç·š...</div>
                </div>
            </div>
        </div>
    </main>

    <!-- æ•™å¸«ç¸½è¦½æˆ°æƒ…å®¤ (Admin Dashboard) -->
    <main id="main-admin" class="flex-1 overflow-y-auto p-4 md:p-8 no-scrollbar relative hidden bg-slate-900 text-white">
        <div class="container mx-auto max-w-7xl">
            <div class="flex justify-between items-center mb-8">
                <div>
                    <h2 class="text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-blue-500">å…¨ç­æ±ºç­–ç¸½è¦½</h2>
                    <p class="text-slate-400 text-sm mt-1">å³æ™‚ç›£æ§å„çµ„æ±ºç­–å‹•æ…‹èˆ‡ SROI è¡¨ç¾</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="bg-slate-800 px-4 py-2 rounded-lg border border-slate-700">
                        <span class="text-xs text-slate-400 block">åœ¨ç·šçµ„æ•¸</span>
                        <span class="text-xl font-bold text-emerald-400" id="admin-team-count">0</span>
                    </div>
                    <button onclick="clearAllData()" class="bg-red-500/20 hover:bg-red-500/40 text-red-400 px-4 py-2 rounded-lg border border-red-500/50 transition-colors flex items-center gap-2">
                        <i data-lucide="trash-2" class="w-4 h-4"></i> é‡ç½®èª²ç¨‹
                    </button>
                </div>
            </div>

            <!-- å…¨ç­çµ±è¨ˆ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                    <h3 class="font-bold text-slate-300 mb-4 flex items-center gap-2"><i data-lucide="pie-chart" class="w-4 h-4"></i> é¸å€åˆ†ä½ˆ</h3>
                    <div class="h-[200px] relative"><canvas id="adminPieChart"></canvas></div>
                </div>
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                    <h3 class="font-bold text-slate-300 mb-4 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-4 h-4"></i> å¹³å‡æŒ‡æ¨™</h3>
                    <div class="h-[200px] relative"><canvas id="adminBarChart"></canvas></div>
                </div>
                <div class="bg-slate-800 p-6 rounded-2xl border border-slate-700">
                    <h3 class="font-bold text-slate-300 mb-4 flex items-center gap-2"><i data-lucide="trophy" class="w-4 h-4"></i> æ’è¡Œæ¦œ</h3>
                    <div class="overflow-y-auto h-[200px] space-y-2 pr-2" id="leaderboard"></div>
                </div>
            </div>

            <!-- å„çµ„å¡ç‰‡ -->
            <h3 class="font-bold text-slate-300 mb-4 flex items-center gap-2"><i data-lucide="grid" class="w-4 h-4"></i> å„çµ„å³æ™‚ç‹€æ…‹</h3>
            <div id="team-cards" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4"></div>
        </div>
    </main>

    <!-- åº•éƒ¨æ“ä½œå€ (å­¸ç”Ÿç”¨) -->
    <div id="student-footer" class="fixed bottom-0 left-0 right-0 bg-white/95 backdrop-blur border-t border-slate-200 p-4 z-40 shadow hidden">
        <div class="container mx-auto max-w-5xl flex justify-between items-center">
            <div class="flex flex-col">
                <div class="text-[10px] text-slate-400 uppercase font-bold tracking-widest">SROI ç¶œåˆè©•åˆ†</div>
                <div class="text-4xl font-black text-slate-800 leading-none tabular-nums" id="footer-score">0.0</div>
            </div>
            <div id="submit-wrapper" class="relative">
                <button onclick="submitFinalDecision()" id="submit-btn" class="bg-slate-900 hover:bg-slate-800 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-all flex items-center gap-2 active:scale-95">
                    æäº¤æ±ºç­– <i data-lucide="send" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, addDoc, getDocs, deleteDoc, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // ================= CONFIG =================
        const firebaseConfig = {
            apiKey: "AIzaSyDMBE9BjTJb70xm8c5WOZaIITxI0PmYWNc",
            authDomain: "tanji-ccus.firebaseapp.com",
            projectId: "tanji-ccus",
            storageBucket: "tanji-ccus.firebasestorage.app",
            messagingSenderId: "118576059306",
            appId: "1:118576059306:web:8f1c7e87b49d4d388651d3"
        };
        // ==========================================

        let db, unsubscribe;
        window.userState = { team: "", role: "" };
        window.teamState = { site: "A", safety: 3, pr: 2, eco: 2, cfo: 2, lastLog: "" };
        window.adminMode = false;

        // è³‡å®‰é›œæ¹Šé©—è­‰ (880619 çš„ SHA-256)
        const ADMIN_HASH = "d4735e3a265e16eee03f59718b9b5d03019c07d8b6c51f90da3a666eec13ab35";

        async function checkPasscode(input) {
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex === ADMIN_HASH;
        }

        // Login UI Logic
        window.selectRole = (role) => {
            window.userState.role = role;
            document.querySelectorAll('.role-btn').forEach(btn => {
                btn.classList.remove('ring-2', 'ring-emerald-500', 'bg-emerald-50');
                btn.classList.add('bg-slate-800');
            });
            event.currentTarget.classList.remove('bg-slate-800');
            event.currentTarget.classList.add('ring-2', 'ring-emerald-500', 'bg-emerald-900');
            checkLoginInput();
        };

        // å³æ™‚æª¢æŸ¥è¼¸å…¥æ¡† (å¦‚æœæ˜¯è€å¸«ï¼Œæœƒè‡ªå‹•é¡¯ç¤ºæŒ‰éˆ•ï¼Œä½†ä¸æç¤ºèº«åˆ†)
        async function checkLoginInput() {
            const t = document.getElementById('login-team').value.trim();
            const btn = document.getElementById('start-btn');
            
            if (!t) {
                btn.disabled = true;
                btn.classList.remove('bg-emerald-600', 'text-white');
                btn.classList.add('bg-slate-700', 'text-slate-500');
                return;
            }

            // æª¢æŸ¥æ˜¯å¦ç‚ºè€å¸«ä»£ç¢¼ (é»˜é»˜æª¢æŸ¥ï¼ŒUIä¸è®Š)
            const isAdmin = await checkPasscode(t);
            
            if (isAdmin) {
                // æ˜¯è€å¸« -> é–‹å•ŸæŒ‰éˆ•ï¼Œä½†ä¿ç•™åŸæ¨£ï¼Œéš±è—è§’è‰²é¸å–®ä»¥é˜²å¹²æ“¾
                document.getElementById('role-selector').style.display = 'none';
                btn.disabled = false;
                btn.classList.remove('bg-slate-700', 'text-slate-500');
                btn.classList.add('bg-emerald-600', 'text-white');
                btn.innerText = "é€²å…¥ç³»çµ±"; // ä¿æŒä½èª¿
                return;
            } else {
                document.getElementById('role-selector').style.display = 'block';
            }

            // ä¸€èˆ¬å­¸ç”Ÿç™»å…¥æª¢æŸ¥ (éœ€æœ‰åç¨± + è§’è‰²)
            if(window.userState.role) {
                btn.disabled = false;
                btn.classList.remove('bg-slate-700', 'text-slate-500');
                btn.classList.add('bg-emerald-600', 'text-white');
                btn.innerText = "é€²å…¥ç³»çµ±";
            } else {
                btn.disabled = true;
            }
        }
        document.getElementById('login-team').addEventListener('input', checkLoginInput);

        // æŒ‰ä¸‹æŒ‰éˆ•å¾Œçš„è·¯ç”±åˆ†æµ
        window.enterSimulation = async () => {
            const teamInput = document.getElementById('login-team').value.trim();
            const btn = document.getElementById('start-btn');
            btn.innerHTML = `<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> é€£ç·šä¸­...`;
            lucide.createIcons();
            
            try {
                if (firebaseConfig.apiKey && firebaseConfig.apiKey.length > 10) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    console.log("ğŸ”¥ Firebase Init");
                } else {
                    console.warn("âš ï¸ Demo Mode");
                    db = null;
                }

                const isAdmin = await checkPasscode(teamInput);
                
                document.getElementById('login-screen').style.display = 'none';

                if (isAdmin) {
                    window.adminMode = true;
                    initAdminDashboard();
                } else {
                    window.userState.team = teamInput;
                    initStudentView();
                }
            } catch(e) { 
                console.error(e); 
                alert("Init Error: " + e.message); 
                btn.innerHTML = "é€²å…¥ç³»çµ±";
            }
        };

        // --- å­¸ç”Ÿç«¯é‚è¼¯ ---
        function initStudentView() {
            document.getElementById('main-student').classList.remove('hidden');
            document.getElementById('student-footer').classList.remove('hidden');
            const roleMap = { 'engineer':'ç’°å¢ƒå·¥ç¨‹å¸«', 'cfo':'è²¡å‹™é•·', 'pr':'å…¬é—œç¶“ç†', 'policy':'æ”¿ç­–åˆ†æå¸«', 'eco':'ç”Ÿæ…‹ä¿è‚²å“¡' };
            document.getElementById('header-team-info').innerText = `${window.userState.team} | ${roleMap[window.userState.role]}`;
            
            if(db) document.getElementById('connection-indicator').innerHTML = `<div class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></div><span class="text-[10px] font-bold text-green-600">å·²é€£ç·š</span>`;
            else document.getElementById('connection-indicator').innerHTML = `<div class="w-2 h-2 bg-orange-400 rounded-full"></div><span class="text-[10px] font-bold text-orange-500">æ¨¡æ“¬ä¸­</span>`;
            
            applyPermissions();
            startSync();
        }

        // --- è€å¸«ç«¯é‚è¼¯ ---
        function initAdminDashboard() {
            document.getElementById('main-admin').classList.remove('hidden');
            if (!db) {
                // Mock Data for Demo
                renderTeamCards([{id:'æ¼”ç¤ºçµ„ A', total:85, site:'A'}, {id:'æ¼”ç¤ºçµ„ B', total:60, site:'B'}]);
                return;
            }
            const q = collection(db, "sessions");
            onSnapshot(q, (snapshot) => {
                const teams = [];
                let stats = { A:0, B:0, C:0, s:0, e:0, o:0 };
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const scores = calcScoreStatic(data);
                    teams.push({ id: doc.id, ...data, ...scores });
                    if(stats[data.site] !== undefined) stats[data.site]++;
                    stats.s += scores.s; stats.e += scores.e; stats.o += scores.o;
                });
                document.getElementById('admin-team-count').innerText = teams.length;
                updateAdminCharts(teams, stats);
                renderTeamCards(teams);
                renderLeaderboard(teams);
            });
        }

        // Admin UI Helpers
        function renderTeamCards(teams) {
            const container = document.getElementById('team-cards');
            container.innerHTML = '';
            teams.forEach(t => {
                const siteIcon = t.site === 'A' ? 'ğŸŒŠ' : (t.site === 'B' ? 'ğŸ­' : 'â›°ï¸');
                const card = document.createElement('div');
                card.className = "bg-slate-800 p-4 rounded-xl border border-slate-700 hover:border-emerald-500 transition-colors";
                card.innerHTML = `<div class="flex justify-between items-center mb-2"><span class="font-bold text-white">${t.id}</span><span class="text-xs bg-slate-700 px-2 py-1 rounded">${siteIcon}</span></div><div class="flex justify-between text-xs text-slate-400 mb-2"><span>SROI: <span class="text-emerald-400 font-bold text-lg">${t.total}</span></span></div><div class="w-full bg-slate-700 h-1.5 rounded-full overflow-hidden"><div class="bg-emerald-500 h-full" style="width: ${t.total}%"></div></div><div class="text-[10px] text-slate-500 mt-2 truncate">æœ€å¾Œæ›´æ–°: ${t.lastLog || 'ç„¡'}</div>`;
                container.appendChild(card);
            });
        }

        function renderLeaderboard(teams) {
            const list = document.getElementById('leaderboard');
            list.innerHTML = '';
            teams.sort((a,b) => parseFloat(b.total) - parseFloat(a.total)).forEach((t, i) => {
                const row = document.createElement('div');
                row.className = "flex justify-between items-center bg-slate-700/50 p-2 rounded text-xs";
                row.innerHTML = `<div class="flex items-center gap-2"><span class="font-bold ${i<3 ? 'text-yellow-400':'text-slate-500'}">#${i+1}</span><span class="text-slate-300">${t.id}</span></div><span class="font-mono text-emerald-400 font-bold">${t.total}</span>`;
                list.appendChild(row);
            });
        }

        window.clearAllData = async () => {
            if(!db) { alert("æ¨¡æ“¬æ¨¡å¼ç„¡æ³•æ¸…é™¤"); return; }
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰å°çµ„æ•¸æ“šå—ï¼Ÿ")) {
                const q = collection(db, "sessions");
                const snapshot = await getDocs(q);
                await Promise.all(snapshot.docs.map(doc => deleteDoc(doc.ref)));
                const q2 = collection(db, "decisions");
                const snapshot2 = await getDocs(q2);
                await Promise.all(snapshot2.docs.map(doc => deleteDoc(doc.ref)));
                alert("èª²ç¨‹å·²é‡ç½®ï¼");
            }
        };

        // Sync Logic
        function startSync() {
            if (!db) { updateUI(); calcScore(); return; }
            const ref = doc(db, "sessions", window.userState.team);
            unsubscribe = onSnapshot(ref, (snap) => {
                if(snap.exists()) {
                    const data = snap.data();
                    window.teamState = { ...window.teamState, ...data };
                    updateUI(); calcScore(); 
                    if(data.lastLog) addLog(data.lastLog);
                } else { setDoc(ref, window.teamState); }
            });
        }

        window.updateTeamState = async (key, val) => {
            window.teamState[key] = val;
            calcScore(); updateUI();
            const roleMap = { 'engineer':'å·¥ç¨‹å¸«', 'cfo':'è²¡å‹™é•·', 'pr':'å…¬é—œ', 'policy':'åˆ†æå¸«', 'eco':'ç”Ÿæ…‹å“¡' };
            const logMsg = `${roleMap[window.userState.role]} èª¿æ•´äº†åƒæ•¸`;
            if(db) {
                const ref = doc(db, "sessions", window.userState.team);
                await setDoc(ref, { [key]: val, lastLog: logMsg, timestamp: serverTimestamp() }, { merge: true });
            }
        };

        function updateUI() {
            const s = window.teamState;
            setSlider('safety', s.safety); setSlider('pr', s.pr); setSlider('eco', s.eco); setSlider('cfo', s.cfo);
            ['A','B','C'].forEach(site => {
                const btn = document.getElementById(`btn-${site}`);
                if(site === s.site) btn.className = "site-card p-3 rounded-xl border-2 border-emerald-500 bg-emerald-50 ring-2 ring-emerald-200 text-center";
                else btn.className = "site-card p-3 rounded-xl border-2 border-slate-100 text-center opacity-60";
            });
        }
        function setSlider(id, val) {
            const el = document.getElementById(`slider-${id}`);
            if(el) el.value = val;
            const labels = ['ä½','åä½','æ¨™æº–','åé«˜','é«˜'];
            const txt = document.getElementById(`val-${id}`);
            if(txt) txt.innerText = labels[val-1] || 'æ¨™æº–';
        }

        function addLog(msg) {
            const log = document.getElementById('system-log');
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            log.prepend(div);
        }

        function applyPermissions() {
            const r = window.userState.role;
            if(r !== 'engineer') lockUI('safety');
            if(r !== 'pr') lockUI('pr');
            if(r !== 'eco') lockUI('eco');
            if(r !== 'cfo') lockUI('cfo');
            if(r !== 'policy') {
                document.getElementById('lock-site').classList.remove('hidden');
            }
        }
        function lockUI(id) {
            document.getElementById(`slider-${id}`).disabled = true;
            document.getElementById(`lock-${id}`).classList.remove('hidden');
        }

        window.submitFinalDecision = async () => {
            const btn = document.getElementById('submit-btn');
            btn.innerHTML = "å‚³é€ä¸­...";
            if (!db) {
                setTimeout(() => { alert("ã€æ¨¡æ“¬æ¨¡å¼ã€‘æ±ºç­–å·²æäº¤ï¼"); btn.innerHTML = "å·²é€å‡º (æ¨¡æ“¬)"; btn.disabled = true; }, 500);
                return;
            }
            try {
                await addDoc(collection(db, "decisions"), {
                    site: window.teamState.site,
                    scores: calcScore(true),
                    user: window.userState.team,
                    timestamp: serverTimestamp()
                });
                alert("å·²é€å‡ºè‡³æˆ°æƒ…å®¤ï¼");
                btn.innerHTML = "å·²é€å‡º";
                btn.disabled = true;
            } catch(e) { console.error(e); alert("ä¸Šå‚³å¤±æ•—ï¼š" + e.message); btn.innerHTML = "æäº¤å¤±æ•—"; }
        }

        const sites = { 'A': {s:85,e:20,o:95}, 'B': {s:50,e:95,o:15}, 'C': {s:70,e:60,o:55} };
        function calcScoreStatic(st) {
            const base = sites[st.site].base;
            let s = Math.min(100, Math.max(0, base.s + (st.safety * 5) + (st.eco * 2) - (st.cfo * 3)));
            if(st.site === 'B') s -= 10;
            let cost = (Math.pow(st.safety, 1.2)*3) + (st.pr * 5) + (st.eco * 4);
            let e = Math.min(100, Math.max(0, base.e + (st.cfo * 8) - cost));
            let o = Math.min(100, Math.max(0, base.o + (st.pr * 8) + (st.eco * 3) - (st.cfo * 2)));
            if(st.site === 'B' && s < 60) o -= 20;
            const total = ((s*0.4)+(e*0.25)+(o*0.35)).toFixed(1);
            return { s, e, o, total };
        }

        let chart;
        function calcScore(ret=false) {
            const res = calcScoreStatic(window.teamState);
            if(!ret) {
                document.getElementById('score-safety').innerText = parseInt(res.s);
                document.getElementById('score-economy').innerText = parseInt(res.e);
                document.getElementById('score-social').innerText = parseInt(res.o);
                document.getElementById('footer-score').innerText = res.total;
                if(chart) { chart.data.datasets[0].data = [res.s, res.e, res.o]; chart.update(); }
            }
            return res;
        }

        let adminPie, adminBar;
        function updateAdminCharts(teams, stats) {
            const count = teams.length || 1;
            if(!adminPie) {
                const ctx = document.getElementById('adminPieChart').getContext('2d');
                adminPie = new Chart(ctx, { type: 'doughnut', data: { labels: ['å¤–æµ·','å·¥æ¥­','æ·±å±±'], datasets:[{data:[0,0,0], backgroundColor:['#3b82f6','#f59e0b','#10b981'], borderColor:'#1e293b'}] }, options: { plugins: { legend: { labels: { color: '#cbd5e1' } } } } });
            }
            adminPie.data.datasets[0].data = [stats.A, stats.B, stats.C]; adminPie.update();

            if(!adminBar) {
                const ctx = document.getElementById('adminBarChart').getContext('2d');
                adminBar = new Chart(ctx, { type: 'bar', data: { labels: ['å®‰å…¨','ç¶“æ¿Ÿ','ç¤¾æœƒ'], datasets:[{label:'å…¨ç­å¹³å‡', data:[0,0,0], backgroundColor:['#3b82f6','#f59e0b','#10b981']}] }, options: { scales: { y: { beginAtZero:true, max:100, grid:{color:'#334155'}, ticks:{color:'#94a3b8'} }, x: { grid:{display:false}, ticks:{color:'#94a3b8'} } }, plugins: { legend: { display:false } } } });
            }
            adminBar.data.datasets[0].data = [stats.s/count, stats.e/count, stats.o/count]; adminBar.update();
        }

        window.onload = () => {
            if(document.getElementById('radarChart')) {
                const ctx = document.getElementById('radarChart').getContext('2d');
                chart = new Chart(ctx, { type: 'radar', data: { labels: ['å®‰å…¨æ€§', 'ç¶“æ¿Ÿ', 'ç¤¾æœƒ'], datasets: [{ data: [50,50,50], backgroundColor: 'rgba(16,185,129,0.2)', borderColor: '#10b981', borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, scales: { r: { min: 0, max: 100, ticks: { display: false } } }, plugins: { legend: { display: false } } } });
            }
            lucide.createIcons();
        };
    </script>
</body>
</html>
